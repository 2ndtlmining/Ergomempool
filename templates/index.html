<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ergomempool</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <img src="/static/Ergomempool_logo_g.svg" alt="Ergo Mempool Visualizer" class="logo-image">
            </div>

            <div class="wallet-section">
                <button id="connect-button" class="connect-button">
                    <img src="/static/wallet/ergo-wallet-white.png" alt="Ergo Wallet" class="wallet-icon">
                    Connect Wallet
                </button>
            </div>
        </header>

        <div class="blocks-section">
            <!-- Next Block Section -->
            <div class="next-block-section" id="next-block-section">
                <h3 class="section-title">Next Block</h3>
                <div class="block-container">
                    <div class="block-height" id="next-block-height">Mining...</div>
                    <div class="dummy-block next-block" id="next-block">
                        <div class="block-size">Pending</div>
                        <div class="block-reward">
                            <span class="reward-label">Est. Reward</span>
                            <span class="reward-value">~15.00 ERG</span>
                        </div>
                        <div class="block-tx-count">Processing...</div>
                    </div>
                </div>
            </div>

            <!-- Separator -->
            <div class="separator-container">
                <div class="separator"></div>
            </div>

            <!-- Last 4 Blocks Section -->
            <div class="last-blocks-section" id="last-blocks-section">
                <h3 class="section-title">Last 4 Blocks</h3>
                <div class="blocks-grid">
                    <div class="block-container">
                        <a href="#" class="block-height-link" id="block-height-link-0" target="_blank">
                            <div class="block-height" id="block-height-0">Loading...</div>
                        </a>
                        <div class="dummy-block" id="block-0">
                            <div class="block-size">Loading...</div>
                            <div class="block-reward">
                                <span class="reward-label">Total Reward</span>
                                <span class="reward-value">Loading...</span>
                            </div>
                            <div class="block-tx-count">Loading...</div>
                        </div>
                        <div class="block-miner" id="block-miner-0">Loading...</div>
                    </div>
                    <div class="block-container">
                        <a href="#" class="block-height-link" id="block-height-link-1" target="_blank">
                            <div class="block-height" id="block-height-1">Loading...</div>
                        </a>
                        <div class="dummy-block" id="block-1">
                            <div class="block-size">Loading...</div>
                            <div class="block-reward">
                                <span class="reward-label">Total Reward</span>
                                <span class="reward-value">Loading...</span>
                            </div>
                            <div class="block-tx-count">Loading...</div>
                        </div>
                        <div class="block-miner" id="block-miner-1">Loading...</div>
                    </div>
                    <div class="block-container">
                        <a href="#" class="block-height-link" id="block-height-link-2" target="_blank">
                            <div class="block-height" id="block-height-2">Loading...</div>
                        </a>
                        <div class="dummy-block" id="block-2">
                            <div class="block-size">Loading...</div>
                            <div class="block-reward">
                                <span class="reward-label">Total Reward</span>
                                <span class="reward-value">Loading...</span>
                            </div>
                            <div class="block-tx-count">Loading...</div>
                        </div>
                        <div class="block-miner" id="block-miner-2">Loading...</div>
                    </div>
                    <div class="block-container">
                        <a href="#" class="block-height-link" id="block-height-link-3" target="_blank">
                            <div class="block-height" id="block-height-3">Loading...</div>
                        </a>
                        <div class="dummy-block" id="block-3">
                            <div class="block-size">Loading...</div>
                            <div class="block-reward">
                                <span class="reward-label">Total Reward</span>
                                <span class="reward-value">Loading...</span>
                            </div>
                            <div class="block-tx-count">Loading...</div>
                        </div>
                        <div class="block-miner" id="block-miner-3">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <main class="visualizer">
            <h2>Mempool Visualizer</h2>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="total-transactions">0</div>
                    <div>Total Transactions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-value">0</div>
                    <div>Total Value (ERG)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-usd-value">$0</div>
                    <div>Total Value (USD)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-size">0</div>
                    <div>Avg Size (bytes)</div>
                </div>
            </div>

            <div class="controls">
                <button class="control-button active" id="color-by-size">Color by Size</button>
                <button class="control-button" id="color-by-value">Color by Value</button>
                <button class="control-button" id="refresh-data">Refresh Data</button>
            </div>

            <div class="mempool-grid" id="mempool-grid">
                <div class="loading">Loading transactions...</div>
            </div>
        </main>

        <section class="transactions">
            <h2>Recent Transactions</h2>
            <table id="transaction-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Size (bytes)</th>
                        <th>Value (ERG)</th>
                        <th>Value ($)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </section>

        <footer class="footer">
            <div class="footer-content">
                <a href="https://github.com/2ndtlmining/Ergomempool" target="_blank" rel="noopener noreferrer" class="github-link" title="View source code on GitHub">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.30.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    <span>v.0.0.1</span>
                 </a>
        
                 <a href="#" class="donation-link" title="Support the project with a donation" id="donation-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                    <span>Donate</span>
                </a>
            </div>
        </footer>
    </div>

    <div class="transaction-tooltip" id="tooltip"></div>

    <!-- Load API functions first -->
    <script src="/static/js/api.js"></script>

    <script>
        let transactions = [];
        let colorMode = 'size';
        let currentPrice = 0;

        // Color palettes for different visualization modes
        const sizeColors = [
            '#27ae60', '#2ecc71', '#f1c40f', '#e67e22', '#e74c3c', '#8e44ad'
        ];
        
        const valueColors = [
            '#3498db', '#2980b9', '#9b59b6', '#8e44ad', '#e74c3c', '#c0392b'
        ];

        // Ergo Wallet Connector Class
        class ErgoWalletConnector {
            constructor() {
                this.connectedWallet = null;
                this.isConnected = false;
                this.connectedAddress = null;
            }

            async detectWallets() {
                const wallets = [];
                
                if (window.ergoConnector) {
                    if (window.ergoConnector.nautilus) {
                        wallets.push({ name: 'Nautilus', api: window.ergoConnector.nautilus });
                    }
                    if (window.ergoConnector.eternl) {
                        wallets.push({ name: 'Eternl', api: window.ergoConnector.eternl });
                    }
                    if (window.ergoConnector.minotaur) {
                        wallets.push({ name: 'Minotaur', api: window.ergoConnector.minotaur });
                    }
                }
                
                return wallets;
            }

            async connectWallet() {
                try {
                    const wallets = await this.detectWallets();
                    
                    if (wallets.length === 0) {
                        throw new Error('No Ergo wallets detected. Please install Nautilus, Eternl, or Minotaur wallet.');
                    }

                    if (wallets.length > 1) {
                        const selectedWallet = await this.showWalletSelectionModal(wallets);
                        if (!selectedWallet) {
                            throw new Error('No wallet selected');
                        }
                        
                        const access = await selectedWallet.api.connect();
                        if (access) {
                            this.connectedWallet = { name: selectedWallet.name };
                            this.isConnected = true;
                            this.connectedAddress = await this.getAddress();
                            return this.connectedWallet;
                        }
                    } else {
                        const wallet = wallets[0];
                        const access = await wallet.api.connect();
                        if (access) {
                            this.connectedWallet = { name: wallet.name };
                            this.isConnected = true;
                            this.connectedAddress = await this.getAddress();
                            return this.connectedWallet;
                        }
                    }
                    
                    throw new Error('Failed to connect to wallet');
                    
                } catch (error) {
                    throw error;
                }
            }

            showWalletSelectionModal(wallets) {
                return new Promise((resolve) => {
                    const overlay = document.createElement('div');
                    overlay.className = 'wallet-modal-overlay';
                    
                    const modal = document.createElement('div');
                    modal.className = 'wallet-modal';
                    modal.innerHTML = `
                        <div class="wallet-modal-header">
                            <h3>Select Wallet</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="wallet-modal-content">
                            <p>Choose which wallet you'd like to connect:</p>
                            <div class="wallet-options">
                                ${wallets.map(wallet => `
                                    <button class="wallet-option" data-wallet="${wallet.name}">
                                        <img src="/static/wallet/ergo-wallet-white.png" alt="${wallet.name}" class="wallet-option-icon">
                                        <span>${wallet.name}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    
                    overlay.appendChild(modal);
                    document.body.appendChild(overlay);
                    
                    const closeModal = () => {
                        document.body.removeChild(overlay);
                        resolve(null);
                    };
                    
                    overlay.querySelector('.modal-close').addEventListener('click', closeModal);
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });
                    
                    overlay.querySelectorAll('.wallet-option').forEach(button => {
                        button.addEventListener('click', () => {
                            const walletName = button.getAttribute('data-wallet');
                            const selectedWallet = wallets.find(w => w.name === walletName);
                            document.body.removeChild(overlay);
                            resolve(selectedWallet);
                        });
                    });
                    
                    setTimeout(() => {
                        overlay.classList.add('show');
                    }, 10);
                });
            }

            async getBalance() {
                if (!this.isConnected) {
                    throw new Error('Wallet not connected');
                }

                try {
                    const balance = await window.ergo.get_balance();
                    return (parseInt(balance) / 1000000000).toFixed(3);
                } catch (error) {
                    throw new Error('Failed to get balance: ' + error.message);
                }
            }

            async getAddress() {
                if (!this.isConnected) {
                    throw new Error('Wallet not connected');
                }

                try {
                    const address = await window.ergo.get_change_address();
                    return address || 'No address found';
                } catch (error) {
                    throw new Error('Failed to get address: ' + error.message);
                }
            }

            disconnect() {
                this.connectedWallet = null;
                this.isConnected = false;
                this.connectedAddress = null;
                if (window.ergo) {
                    console.log('Wallet disconnected');
                }
            }
        }

        // Initialize wallet connector
        const walletConnector = new ErgoWalletConnector();

        // Helper functions for wallet integration
        function showWalletStatus(message, type = 'info') {
            const existingStatus = document.querySelector('.wallet-status');
            if (existingStatus) {
                existingStatus.remove();
            }

            const statusDiv = document.createElement('div');
            statusDiv.className = `wallet-status ${type}`;
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            
            setTimeout(() => statusDiv.classList.add('show'), 100);
            
            setTimeout(() => {
                statusDiv.classList.remove('show');
                setTimeout(() => statusDiv.remove(), 300);
            }, 4000);
        }

        function showWalletInfo(info) {
            const existingInfo = document.querySelector('.wallet-info-display');
            if (existingInfo) {
                existingInfo.remove();
            }

            if (!info) return;

            const walletInfoDiv = document.createElement('div');
            walletInfoDiv.className = 'wallet-info-display';
            walletInfoDiv.innerHTML = `
                <div class="wallet-content">
                    <strong>${info.name} Connected</strong>
                    <div class="balance">Balance: ${info.balance} ERG</div>
                    <div class="address">${info.address.substring(0, 20)}...</div>
                </div>
                <div class="wallet-disconnect" style="display: none;">
                    <button class="disconnect-btn">Disconnect</button>
                </div>
            `;

            walletInfoDiv.addEventListener('click', function(e) {
                if (e.target.classList.contains('disconnect-btn')) {
                    walletConnector.disconnect();
                    document.getElementById('connect-button').innerHTML = `
                        <img src="/static/wallet/ergo-wallet-white.png" alt="Ergo Wallet" class="wallet-icon">
                        Connect Wallet
                    `;
                    document.getElementById('connect-button').classList.remove('connected');
                    showWalletInfo(null);
                    showWalletStatus('Wallet disconnected', 'info');
                    return;
                }

                const disconnectDiv = this.querySelector('.wallet-disconnect');
                const content = this.querySelector('.wallet-content');
                
                if (disconnectDiv.style.display === 'none') {
                    disconnectDiv.style.display = 'block';
                    content.style.opacity = '0.7';
                    this.classList.add('expanded');
                } else {
                    disconnectDiv.style.display = 'none';
                    content.style.opacity = '1';
                    this.classList.remove('expanded');
                }
            });

            const walletSection = document.querySelector('.wallet-section');
            walletSection.appendChild(walletInfoDiv);
        }

        function isWalletTransaction(transaction, walletAddress) {
            if (!walletAddress || !transaction) return false;
            
            const inputMatch = transaction.inputs && transaction.inputs.some(input => 
                input.address === walletAddress
            );
            
            const outputMatch = transaction.outputs && transaction.outputs.some(output => 
                output.address === walletAddress
            );
            
            return inputMatch || outputMatch;
        }

        function shortenTransactionId(id, startChars = 5, endChars = 5) {
            if (!id || id.length <= startChars + endChars + 3) {
                return id;
            }
            return `${id.substring(0, startChars)}...${id.substring(id.length - endChars)}`;
        }

        function getColorBySize(size, maxSize) {
            const normalized = Math.min(size / maxSize, 1);
            const index = Math.floor(normalized * (sizeColors.length - 1));
            return sizeColors[index];
        }

        function getColorByValue(value, maxValue) {
            const normalized = Math.min(value / maxValue, 1);
            const index = Math.floor(normalized * (valueColors.length - 1));
            return valueColors[index];
        }

        function getSquareSize(value, maxValue, minSize = 8, maxSizePixels = 24) {
            const normalized = Math.min(value / maxValue, 1);
            return Math.max(minSize, Math.floor(minSize + (maxSizePixels - minSize) * normalized));
        }

        function createVisualization() {
            const grid = document.getElementById('mempool-grid');
            grid.innerHTML = '';

            if (transactions.length === 0) {
                grid.innerHTML = '<div class="loading">No transactions available</div>';
                return;
            }

            const maxSize = Math.max(...transactions.map(tx => tx.size || 0));
            const maxValue = Math.max(...transactions.map(tx => tx.value || 0));

            const displayTransactions = transactions.slice(0, 500);

            displayTransactions.forEach((tx, index) => {
                const square = document.createElement('div');
                square.className = 'transaction-square';
                
                const size = getSquareSize(colorMode === 'size' ? tx.size : tx.value, 
                                         colorMode === 'size' ? maxSize : maxValue);
                
                const color = colorMode === 'size' 
                    ? getColorBySize(tx.size || 0, maxSize)
                    : getColorByValue(tx.value || 0, maxValue);

                square.style.width = `${size}px`;
                square.style.height = `${size}px`;
                square.style.backgroundColor = color;
                square.style.gridColumn = `span ${Math.max(1, Math.floor(size / 8))}`;
                square.style.gridRow = `span ${Math.max(1, Math.floor(size / 8))}`;

                if (walletConnector.isConnected && walletConnector.connectedAddress) {
                    if (isWalletTransaction(tx, walletConnector.connectedAddress)) {
                        square.classList.add('wallet-transaction');
                        square.style.border = '3px solid #f39c12';
                        square.style.boxShadow = '0 0 15px rgba(243, 156, 18, 0.9), 0 0 30px rgba(243, 156, 18, 0.6), 0 0 45px rgba(243, 156, 18, 0.3)';
                        square.style.zIndex = '10';
                        square.style.position = 'relative';
                        square.style.animation = 'walletGlow 2s ease-in-out infinite alternate';
                    }
                }

                square.addEventListener('mouseenter', (e) => {
                    showTooltip(e, tx);
                });

                square.addEventListener('mouseleave', () => {
                    hideTooltip();
                });

                square.addEventListener('click', () => {
                    window.open(`https://sigmaspace.io/en/transaction/${tx.id}`, '_blank');
                });

                grid.appendChild(square);
            });
        }

        function showTooltip(event, tx) {
            const tooltip = document.getElementById('tooltip');
            const usdValue = tx.usd_value || 0;
            const shortId = shortenTransactionId(tx.id, 8, 8);
            
            const isWalletTx = walletConnector.isConnected && walletConnector.connectedAddress && 
                              isWalletTransaction(tx, walletConnector.connectedAddress);
            
            let walletInfo = '';
            if (isWalletTx) {
                walletInfo = '<div style="color: #f39c12; font-weight: bold; margin-bottom: 4px;">ðŸŒŸ Your Wallet Transaction</div>';
            }
            
            tooltip.innerHTML = `
                ${walletInfo}
                <strong>Transaction</strong><br>
                ID: ${shortId}<br>
                Size: ${tx.size || 'N/A'} bytes<br>
                Value: ${(tx.value || 0).toFixed(4)} ERG<br>
                Value: ${usdValue.toFixed(2)} USD
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function updateNextBlockInfo() {
            if (transactions.length === 0) {
                document.getElementById('next-block-height').textContent = 'Mining...';
                document.getElementById('next-block').innerHTML = `
                    <div class="block-size">Pending</div>
                    <div class="block-reward">
                        <span class="reward-label">Est. Reward</span>
                        <span class="reward-value" id="next-block-reward">~15.00 ERG</span>
                    </div>
                    <div class="block-tx-count">Processing...</div>
                `;
                return;
            }

            const totalTransactions = transactions.length;
            const totalSize = transactions.reduce((sum, tx) => sum + (tx.size || 0), 0);
            
            document.getElementById('next-block-height').textContent = 'Mining...';
            document.getElementById('next-block').innerHTML = `
                <div class="block-size">${(totalSize / 1000000).toFixed(2)} MB</div>
                <div class="block-reward">
                    <span class="reward-label">Est. Reward</span>
                    <span class="reward-value" id="next-block-reward">~15.00 ERG</span>
                </div>
                <div class="block-tx-count">${totalTransactions.toLocaleString()} transactions</div>
            `;
        }

        function updateNextBlockReward(baseMinerReward) {
            const rewardElement = document.getElementById('next-block-reward');
            if (rewardElement && baseMinerReward) {
                rewardElement.textContent = `~${baseMinerReward.toFixed(2)} ERG`;
            }
        }

        function updateStats() {
            const totalTx = transactions.length;
            const totalValue = transactions.reduce((sum, tx) => sum + (tx.value || 0), 0);
            const totalUsdValue = transactions.reduce((sum, tx) => sum + (tx.usd_value || 0), 0);
            const avgSize = totalTx > 0 ? Math.round(transactions.reduce((sum, tx) => sum + (tx.size || 0), 0) / totalTx) : 0;

            document.getElementById('total-transactions').textContent = totalTx;
            document.getElementById('total-value').textContent = totalValue.toFixed(2);
            document.getElementById('total-usd-value').textContent = '$' + totalUsdValue.toFixed(2);
            document.getElementById('avg-size').textContent = avgSize;
        }

        let previousBlockData = null;

        function animateBlockTransition(newBlocks) {
            if (!previousBlockData || !newBlocks || newBlocks.length === 0) {
                previousBlockData = [...newBlocks];
                return false;
            }

            const hasNewBlock = newBlocks[0] && previousBlockData[0] && 
                              newBlocks[0].height !== previousBlockData[0].height;

            console.log('Checking for new block:', {
                newHeight: newBlocks[0]?.height,
                previousHeight: previousBlockData[0]?.height,
                hasNewBlock: hasNewBlock
            });

            if (hasNewBlock) {
                console.log('New block detected, starting animation');
                performBlockAnimation(newBlocks);
                previousBlockData = [...newBlocks];
                return true;
            }

            previousBlockData = [...newBlocks];
            return false;
        }

        function performBlockAnimation(newBlocks) {
            animateNextBlockToRight(newBlocks);
        }

        function animateNextBlockToRight(newBlocks) {
            const nextBlock = document.getElementById('next-block');
            const nextBlockContainer = nextBlock.parentElement;
            
            const block0Container = document.getElementById('block-0').parentElement;
            const block1Container = document.getElementById('block-1').parentElement;
            const block2Container = document.getElementById('block-2').parentElement;
            const block3Container = document.getElementById('block-3').parentElement;
            
            nextBlockContainer.style.transform = 'translateX(400px)';
            nextBlockContainer.style.transition = 'all 0.8s ease';
            
            block0Container.style.transform = 'translateX(220px)';
            block0Container.style.transition = 'all 0.8s ease';
            
            block1Container.style.transform = 'translateX(220px)';
            block1Container.style.transition = 'all 0.8s ease';
            
            block2Container.style.transform = 'translateX(220px)';
            block2Container.style.transition = 'all 0.8s ease';
            
            block3Container.style.transform = 'translateX(440px)';
            block3Container.style.opacity = '0';
            block3Container.style.transition = 'all 0.8s ease';
            
            setTimeout(() => {
                updateBlocksWithAnimation(newBlocks);
                resetAllBlocks([nextBlockContainer, block0Container, block1Container, block2Container, block3Container]);
            }, 800);
        }

        function resetAllBlocks(containers) {
            containers.forEach(container => {
                container.style.transform = '';
                container.style.transition = '';
                container.style.opacity = '';
            });
            
            updateNextBlockInfo();
            
            const nextBlockContainer = document.getElementById('next-block').parentElement;
            nextBlockContainer.classList.add('block-fade-in');
            setTimeout(() => {
                nextBlockContainer.classList.remove('block-fade-in');
            }, 600);
        }

        function calculateTimeAgo(timestamp) {
            const now = Date.now();
            const blockTime = timestamp;
            const diffInMinutes = Math.floor((now - blockTime) / (1000 * 60));
            
            if (diffInMinutes < 1) {
                return "< 1 min ago";
            } else if (diffInMinutes === 1) {
                return "1 min ago";
            } else if (diffInMinutes < 60) {
                return `${diffInMinutes} mins ago`;
            } else {
                const hours = Math.floor(diffInMinutes / 60);
                const remainingMins = diffInMinutes % 60;
                if (hours === 1) {
                    return remainingMins > 0 ? `1h ${remainingMins}m ago` : "1h ago";
                } else {
                    return remainingMins > 0 ? `${hours}h ${remainingMins}m ago` : `${hours}h ago`;
                }
            }
        }

        function updateBlocksWithAnimation(blockLabels) {
            blockLabels.forEach((block, i) => {
                if (i < 4) {
                    const heightElement = document.getElementById(`block-height-${i}`);
                    if (heightElement) {
                        heightElement.textContent = block.height;
                    }

                    const heightLinkElement = document.getElementById(`block-height-link-${i}`);
                    if (heightLinkElement && block.id) {
                        heightLinkElement.href = `https://sigmaspace.io/en/block/${block.id}`;
                    }

                    const blockElement = document.getElementById(`block-${i}`);  
                    if (blockElement) {
                        blockElement.style.background = 'linear-gradient(135deg, #8e44ad, #9b59b6)';
                        blockElement.style.border = '2px solid #7d3c98';
                        blockElement.style.animation = 'none';
                        
                        let timeAgoText = '';
                        if (block.timestamp) {
                            timeAgoText = calculateTimeAgo(block.timestamp);
                        }
                        
                        blockElement.innerHTML = `
                            <div class="block-size">${(block.size / 1000000).toFixed(2)} MB</div>
                            <div class="block-reward">
                                <span class="reward-label">Total Reward</span>
                                <span class="reward-value">${block.minerReward.toFixed(3)} ERG</span>
                                ${block.totalFees && block.totalFees > 0 ? 
                                    `<span class="fees-breakdown">${block.totalFees.toFixed(3)} fees</span>` : 
                                    ''
                                }
                            </div>
                            <div class="block-tx-count">${block.transactionsCount.toLocaleString()} transactions</div>
                            ${timeAgoText ? `<div class="block-time">${timeAgoText}</div>` : ''}
                        `;
                    }

                    const minerElement = document.getElementById(`block-miner-${i}`);
                    if (minerElement && block.minerInfo) {
                        const minerName = block.minerInfo.name || 'Unknown';
                        const minerLogo = block.minerInfo.logo;
                        
                        if (minerLogo) {
                            minerElement.innerHTML = `
                                <img src="${minerLogo}" alt="${minerName}" class="miner-logo" onerror="this.style.display='none'">
                                <span>${minerName}</span>
                            `;
                        } else {
                            minerElement.innerHTML = `<span>${minerName}</span>`;
                        }
                    }
                }
            });
        }

        function populateTransactionTable() {
            const tbody = document.querySelector('#transaction-table tbody');
            tbody.innerHTML = '';

            const displayTransactions = transactions.slice(0, 20);

            displayTransactions.forEach(tx => {
                const usdValue = tx.usd_value || 0;
                const shortId = shortenTransactionId(tx.id);
                
                const isWalletTx = walletConnector.isConnected && walletConnector.connectedAddress && 
                                  isWalletTransaction(tx, walletConnector.connectedAddress);
                
                const row = document.createElement('tr');
                if (isWalletTx) {
                    row.classList.add('wallet-transaction-row');
                    row.style.backgroundColor = 'rgba(243, 156, 18, 0.1)';
                    row.style.borderLeft = '3px solid #f39c12';
                }
                
                row.innerHTML = `
                    <td>
                        ${isWalletTx ? '<span style="color: #f39c12; margin-right: 4px;">ðŸŒŸ</span>' : ''}
                        <a href="https://sigmaspace.io/en/transaction/${tx.id}" target="_blank">${shortId}</a>
                    </td>
                    <td>${tx.size || 'N/A'}</td>
                    <td>${(tx.value || 0).toFixed(4)}</td>
                    <td>${usdValue.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });

            if (displayTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="loading">No transactions available</td></tr>';
            }
        }

        // Event listeners
        document.getElementById('color-by-size').addEventListener('click', function() {
            colorMode = 'size';
            document.querySelectorAll('.control-button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            createVisualization();
        });

        document.getElementById('color-by-value').addEventListener('click', function() {
            colorMode = 'value';
            document.querySelectorAll('.control-button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            createVisualization();
        });

        document.getElementById('refresh-data').addEventListener('click', function() {
            this.textContent = 'Refreshing...';
            loadTransactions();
            loadBlockLabels();
            loadPrice();
            setTimeout(() => {
                this.textContent = 'Refresh Data';
            }, 1000);
        });

        // Wallet connection event listener
        document.addEventListener('DOMContentLoaded', function() {
            const connectButton = document.getElementById('connect-button');
            
            connectButton.addEventListener('click', async function() {
                if (walletConnector.isConnected) {
                    walletConnector.disconnect();
                    this.innerHTML = `
                        <img src="/static/wallet/ergo-wallet-white.png" alt="Ergo Wallet" class="wallet-icon">
                        Connect Wallet
                    `;
                    this.classList.remove('connected');
                    showWalletInfo(null);
                    showWalletStatus('Wallet disconnected', 'info');
                } else {
                    try {
                        this.innerHTML = `
                            <img src="/static/wallet/ergo-wallet-white.png" alt="Ergo Wallet" class="wallet-icon">
                            Connecting...
                        `;
                        this.disabled = true;
                        
                        showWalletStatus('Connecting to wallet...', 'info');
                        
                        const wallet = await walletConnector.connectWallet();
                        const address = await walletConnector.getAddress();
                        const balance = await walletConnector.getBalance();
                        
                        this.innerHTML = `
                            <img src="/static/wallet/ergo-wallet-white.png" alt="Ergo Wallet" class="wallet-icon">
                            Disconnect
                        `;
                        this.classList.add('connected');
                        
                        showWalletInfo({
                            name: wallet.name,
                            address: address,
                            balance: balance
                        });
                        
                        showWalletStatus(`Successfully connected to ${wallet.name}!`, 'success');
                        
                    } catch (error) {
                        showWalletStatus('Failed to connect: ' + error.message, 'error');
                        console.error('Wallet connection error:', error);
                    } finally {
                        this.disabled = false;
                        if (!walletConnector.isConnected) {
                            this.innerHTML = `
                                <img src="/static/wallet/ergo-wallet-white.png" alt="Ergo Wallet" class="wallet-icon">
                                Connect Wallet
                            `;
                        }
                    }
                }
            });

            setTimeout(async () => {
                const wallets = await walletConnector.detectWallets();
                if (wallets.length === 0) {
                    connectButton.title = 'No Ergo wallets detected. Please install Nautilus, Eternl, or Minotaur.';
                    connectButton.style.opacity = '0.7';
                } else {
                    connectButton.title = `Connect to your Ergo wallet (${wallets.map(w => w.name).join(', ')} detected)`;
                }
            }, 1000);

            loadPrice();
            loadTransactions();
            loadBlockLabels();
            
            setInterval(() => {
                loadTransactions();
                loadBlockLabels();
            }, 30000);

            setInterval(() => {
                loadPrice();
            }, 300000);
        });
    </script>
</body>
</html>